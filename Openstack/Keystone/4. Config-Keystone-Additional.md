

# Cấu hình Keystone với các Openstack Service khác



## 1. Khởi tạo Service User

- Để cấu hình Openstack Service , trước hết cần khởi tạo một project cho các service, và user cho mỗi service. Sau đó gán quyền `admin` cho các các service user, đề các user này có thể xác thực token, xác thực các request mà các user gửi đến
- Khởi tạo service project, thông thường sẽ đặt tên là `service`
```
[root@localhost ~]# openstack project create service
[root@localhost ~]# openstack project list
+----------------------------------+---------+
| ID                               | Name    |
+----------------------------------+---------+
| 2f6d32f44a074bcab270084b989c2fd2 | service |
| baedd3b48fbc4134ac1eba01798addea | admin   |
+----------------------------------+---------+
```
- Sau đó khởi tạo các user cho các service trong phá trình phát triển : nova, neutron, glance, swift 
```
[root@localhost ~]# openstack user create nova --password nova_123@123Aa --project service
+---------------------+----------------------------------+
| Field               | Value                            |
+---------------------+----------------------------------+
| default_project_id  | 2f6d32f44a074bcab270084b989c2fd2 |
| domain_id           | default                          |
| enabled             | True                             |
| id                  | c269e7fde56a42578e7e2a2fc788222c |
| name                | nova                             |
| options             | {}                               |
| password_expires_at | None                             |
+---------------------+----------------------------------+
```

- Sau khi tạo thành công tài khoản `nova` , sẽ gắn quyền `admin ` cho tài khoản này
```
[root@localhost ~]# openstack role add admin --project service --user nova
```


## 2. Định nghĩa các Service

- Keystone phân chia các Service Catalog để các Service có thể nhận biết nhau thông qua các API 
endpoint. 
- Keystone hỗ trợ 2 kiểu định nghĩa service 
	 - Catelog template , định nghĩa các catalog vào template 
	 - SQL backend cho catalog service, thêm các service vào template

```
	[root@localhost ~]# openstack service create compute --name nova --description "Compute 		Service"
	+-------------+----------------------------------+
	| Field       | Value                            |
	+-------------+----------------------------------+
	| description | Compute Service                  |
	| enabled     | True                             |
	| id          | 442475ce04704ad3ac1aa71d83ad390e |
	| name        | nova                             |
	| type        | compute                          |
	+-------------+----------------------------------+
```


## 3. Service Catalog
Trong Openstack hỗ trợ 2 kiểu cấu hình để lưu trữ Service Catalog

- SQL-based Service Catalog (`sql.Catalog`)
Hỗ trợ cấu hình liên tục các catalog
- Để cấu hình , trong  ` /etc/keystone/keystone.conf ` cần định nghĩa driver trong section `mysql`
```
[catalog]
driver = sql
```

- File-based Service Catalog (`templated.Catalog`)
Các catalog được lưu bởi file-base sẽ được khởi tạo từ template_file chỉ cho đọc . Trong trường hợp này catalog service sẽ không thay đổi nhiều theo thời gian.
- Cấu hình file-base catalog trong keystone.conf
```
[catalog]
driver = templated
template_file = /opt/stack/keystone/etc/default_catalog.templates
```

## 4. Xác thực Openstack thông qua CLI

- Tạo biến môi trường
```
export OS_USERNAME=admin
export OS_PASSWORD=
export OS_PROJECT_NAME=admin
export OS_AUTH_URL=http://controller:5000/v3
```

## 5. Public ID Generators

- Keystone sử dụng thuật toán SHA256 để khởi tạo các Public ID cho các User và Group 
- Hỗ trợ tối đa 64 ký tự  cho các Public ID  
